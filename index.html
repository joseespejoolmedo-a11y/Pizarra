<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R√∫brica EF</title>

  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --muted:#6b7280; --line:#e5e7eb;
      --blue:#2563eb; --green:#16a34a; --amber:#f59e0b; --red:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,sans-serif}
    .wrap{max-width:1400px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
    h1{margin:6px 0 12px;text-align:center;font-size:1.25rem}

    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:6px 0 10px}
    .chip{border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip b{font-size:.9rem}
    select,input[type="text"]{
      border:1px solid var(--line);border-radius:999px;padding:9px 12px;font-weight:900;max-width:320px;background:#fff
    }

    .btn{border:none;border-radius:999px;padding:10px 14px;font-weight:950;cursor:pointer}
    .primary{background:var(--blue);color:#fff}
    .ok{background:var(--green);color:#fff}
    .warn{background:var(--amber);color:#111827}
    .danger{background:#fee2e2;color:var(--red)}
    .ghost{background:#eef2ff;color:#1e3a8a}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    label{display:block;font-weight:950;margin:6px 0 6px}
    textarea{
      width:100%;border:1px solid var(--line);border-radius:14px;padding:10px;font-size:.95rem;
      min-height:96px;resize:vertical
    }
    input.wide{width:100%;border-radius:14px;border:1px solid var(--line);padding:10px;font-weight:900}
    .hint{margin:6px 0 0;color:var(--muted);font-size:.85rem;line-height:1.25}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin:12px 0 6px}
    .stats{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0 0}
    .stat{border:1px solid var(--line);background:#f9fafb;border-radius:12px;padding:10px 12px;min-width:250px}
    .stat b{display:block;color:#374151;font-size:.85rem;margin-bottom:4px}
    .stat .big{font-size:1.25rem;font-weight:1000}
    .mini{color:var(--muted);font-size:.8rem;font-weight:900}
    .note{color:var(--muted);font-size:.82rem;font-weight:850;margin-top:8px;text-align:center}
    .sep{height:1px;background:var(--line);margin:12px 0}

    .tableWrap{margin-top:12px;border:1px solid var(--line);border-radius:14px;overflow:auto;background:#fff}
    table{border-collapse:collapse;width:100%;min-width:1400px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:center;vertical-align:middle}
    th{position:sticky;top:0;background:#f3f4f6;z-index:3;font-size:.86rem}
    td:first-child, th:first-child{position:sticky;left:0;z-index:4;text-align:left;background:#fff;font-weight:1000;min-width:210px}
    th:first-child{background:#f3f4f6}
    th .w{display:block;color:var(--muted);font-weight:900;font-size:.78rem;margin-top:2px}
    td.avg, th.avg{min-width:90px;font-weight:1000}
    td.nota, th.nota{min-width:90px;font-weight:1000}
    th.comment, td.comment{min-width:300px;text-align:left}

    .cellBtn{
      width:100%; min-height:44px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.10);
      font-weight:1000;
      font-size:1.05rem;
      cursor:pointer;
      background:#e5e7eb;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }

    .commentBox{
      width:100%;
      min-height:44px;
      border:1px solid rgba(0,0,0,.10);
      border-radius:12px;
      padding:8px 10px;
      font-weight:800;
      font-size:.92rem;
      resize:vertical;
      background:#fff;
    }

    .tip{
      position:fixed; left:14px; right:14px; bottom:14px;
      max-width:980px; margin:0 auto;
      background:#111827; color:#fff;
      border-radius:14px; padding:12px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      z-index:9999; display:none;
    }
    .tip .t{font-weight:1000;margin:0 0 6px}
    .tip .s{color:#d1d5db;font-weight:850;margin:0}
    .tip .x{position:absolute;top:8px;right:10px;background:transparent;border:0;color:#fff;font-weight:1000;font-size:18px;cursor:pointer}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>üìã R√∫brica EF (editable sin perder datos)</h1>

      <div class="topbar">
        <div class="chip">
          <b>Curso</b>
          <select id="courseSelect"></select>
          <button class="btn ghost" id="renameCourse">Renombrar</button>
          <input id="courseName" type="text" placeholder="Nuevo curso (ej: 2¬∫ ESO B)" />
          <button class="btn ok" id="addCourse">A√±adir</button>
          <button class="btn danger" id="delCourse" title="Eliminar curso (y sus r√∫bricas)">Eliminar</button>
        </div>

        <div class="chip">
          <b>R√∫brica</b>
          <select id="rubricSelect"></select>
          <button class="btn ghost" id="renameRubric">Renombrar</button>
          <input id="rubricName" type="text" placeholder="Nueva r√∫brica (ej: Baloncesto - 1¬™ eval)" />
          <button class="btn ok" id="addRubric">A√±adir</button>
          <button class="btn warn" id="dupRubric">Duplicar</button>
          <button class="btn danger" id="delRubric">Eliminar</button>
        </div>
      </div>

      <div class="topbar">
        <div class="chip">
          <b>Copiar r√∫brica desde otro curso</b>
          <select id="copyFromCourse"></select>
          <select id="copyFromRubric"></select>
          <button class="btn ghost" id="copyNoMarks">Copiar SIN notas</button>
          <button class="btn warn" id="copyWithMarks">Copiar CON notas</button>
        </div>
      </div>

      <div class="note">
        ‚úÖ Para editar SIN perder notas: cambia alumnado/indicadores/pesos y pulsa <b>Aplicar cambios</b>.<br>
        ‚ö†Ô∏è <b>Crear / Rehacer</b> crea la tabla desde cero (lo normal al principio).
      </div>

      <div class="sep"></div>

      <div class="grid">
        <div>
          <label>Alumnado (uno por l√≠nea)</label>
          <textarea id="alumnos" placeholder="Ana P√©rez&#10;Carlos D√≠az&#10;Luc√≠a Mart√≠n"></textarea>
          <div class="hint">Puedes reordenar / a√±adir / quitar. Luego pulsa <b>Aplicar cambios</b>.</div>
        </div>

        <div>
          <label>Indicadores (por comas o uno por l√≠nea)</label>
          <textarea id="indicadores" placeholder="Control del pase, Movimiento sin bal√≥n, Cooperaci√≥n"></textarea>
          <div class="hint">Puedes a√±adir/quitar/reordenar. Se conservan notas por coincidencia del <b>nombre del indicador</b>.</div>

          <label style="margin-top:10px;">Pesos/ponderaci√≥n % (opcional)</label>
          <input id="pesos" class="wide" type="text" placeholder="50,30,20  (si vac√≠o: reparte igual)" />
          <div class="hint">Si no suman 100, se normalizan. Cambiar pesos NO borra notas.</div>
        </div>
      </div>

      <label style="margin-top:12px;">Descripciones por indicador (opcional) ‚Äî tooltip</label>
      <textarea id="descripciones" placeholder="Ejemplo:
Control del pase | 1: Pierde; 2: Irregular; 3: Correcto; 4: Excelente
Movimiento sin bal√≥n | 1: No; 2: Tarde; 3: Bien; 4: Ventaja"></textarea>
      <div class="hint">
        Formato: <b>Indicador | 1: ...; 2: ...; 3: ...; 4: ...</b> (una l√≠nea por indicador).<br>
        Pulsaci√≥n larga sobre una celda ‚Üí muestra descripci√≥n.
      </div>

      <div class="row">
        <button class="btn primary" id="btnCrear">Crear / Rehacer (desde cero)</button>
        <button class="btn warn" id="btnAplicar">Aplicar cambios (sin perder notas)</button>
        <button class="btn ghost" id="btnGuardar">Guardar textos</button>
        <button class="btn ok" id="btnExport">Exportar CSV</button>
      </div>

      <div class="stats">
        <div class="stat">
          <b>Media clase (0‚Äì4) ponderada</b>
          <div class="big" id="mediaClase">‚Äî</div>
          <div class="mini">seg√∫n pesos</div>
        </div>
        <div class="stat">
          <b>Nota media clase (/10)</b>
          <div class="big" id="notaClase">‚Äî</div>
          <div class="mini">de 0 a 10</div>
        </div>
        <div class="stat">
          <b>% celdas evaluadas</b>
          <div class="big" id="pctEval">‚Äî</div>
          <div class="mini">progreso</div>
        </div>
      </div>

      <div id="tabla"></div>
    </div>
  </div>

  <div class="tip" id="tip">
    <button class="x" id="tipClose">√ó</button>
    <p class="t" id="tipTitle"></p>
    <p class="s" id="tipText"></p>
  </div>

<script>
/* =========================
   NIVELES: solo n√∫mero + color
   ========================= */
const LEVELS = [
  {n:0, color:"#e5e7eb"},
  {n:1, color:"#fecaca"},
  {n:2, color:"#fed7aa"},
  {n:3, color:"#fef3c7"},
  {n:4, color:"#bbf7d0"},
];
function levelTo10(n){ return (n<=0) ? 0 : (n/4)*10; }

/* =========================
   DB (cursos + r√∫bricas)
   ========================= */
/* ‚ö†Ô∏è NO CAMBIES esto si quieres mantener tus datos.
   Si tu app actual usa otro DB_KEY, pon EXACTAMENTE el mismo aqu√≠. */
const DB_KEY = "rubricaEF_db_v3";

function loadDB(){
  try{
    const raw = localStorage.getItem(DB_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function defaultDB(){
  const courseId = uid();
  const rubricId = uid();
  return {
    activeCourseId: courseId,
    activeRubricId: rubricId,
    courses: {
      [courseId]: {
        name: "Curso 1",
        rubrics: {
          [rubricId]: {
            name: "R√∫brica 1",
            alumnos: "",
            indicadores: "",
            pesos: "",
            descripciones: "",
            tableState: null
          }
        }
      }
    }
  };
}

let db = loadDB() || defaultDB();

/* =========================
   DOM
   ========================= */
const $courseSelect = document.getElementById("courseSelect");
const $rubricSelect = document.getElementById("rubricSelect");
const $courseName = document.getElementById("courseName");
const $rubricName = document.getElementById("rubricName");

const $copyFromCourse = document.getElementById("copyFromCourse");
const $copyFromRubric = document.getElementById("copyFromRubric");

const $alumnos = document.getElementById("alumnos");
const $indicadores = document.getElementById("indicadores");
const $pesos = document.getElementById("pesos");
const $descripciones = document.getElementById("descripciones");
const $tabla = document.getElementById("tabla");

const $mediaClase = document.getElementById("mediaClase");
const $notaClase = document.getElementById("notaClase");
const $pctEval = document.getElementById("pctEval");

const $tip = document.getElementById("tip");
const $tipTitle = document.getElementById("tipTitle");
const $tipText = document.getElementById("tipText");
document.getElementById("tipClose").onclick = () => hideTip();

/* =========================
   Helpers
   ========================= */
function escapeHTML(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function parseAlumnos(txt){
  return txt.split("\n").map(s=>s.trim()).filter(Boolean);
}
function parseIndicadores(txt){
  const t = txt.trim();
  if(!t) return [];
  if(t.includes(",")) return t.split(",").map(s=>s.trim()).filter(Boolean);
  return t.split("\n").map(s=>s.trim()).filter(Boolean);
}
function parseWeights(txt, n){
  const t = (txt||"").trim();
  if(!t){
    const eq = 100/n;
    return Array(n).fill(eq);
  }
  let w = t.split(",").map(x => Number(String(x).trim().replace(",", "."))).filter(x => isFinite(x) && x>=0);
  if(w.length !== n){
    const eq = 100/n;
    return Array(n).fill(eq);
  }
  const sum = w.reduce((a,b)=>a+b,0) || 1;
  return w.map(x => (x/sum)*100);
}
function parseIndicatorDescriptions(txt){
  const map = new Map();
  const lines = (txt||"").split("\n").map(l=>l.trim()).filter(Boolean);
  for(const line of lines){
    const parts = line.split("|");
    if(parts.length < 2) continue;
    const name = parts[0].trim();
    const rhs = parts.slice(1).join("|").trim();
    const levelMap = {1:"",2:"",3:"",4:""};
    const chunks = rhs.split(";").map(x=>x.trim()).filter(Boolean);
    for(const c of chunks){
      const m = c.match(/^([1-4])\s*:\s*(.+)$/);
      if(m) levelMap[Number(m[1])] = m[2].trim();
    }
    map.set(name, levelMap);
  }
  return map;
}
function defaultDesc(n){
  if(n===1) return "Inicio";
  if(n===2) return "B√°sico";
  if(n===3) return "Adecuado";
  if(n===4) return "Avanzado";
  return "Sin evaluar";
}
function getDesc(indName, n, descMap){
  if(n===0) return "Sin evaluar";
  const m = descMap.get(indName);
  if(m && m[n]) return m[n];
  return defaultDesc(n);
}

/* =========================
   Tooltip long-press
   ========================= */
let pressTimer = null;
function attachLongPress(el, fn){
  const start = () => {
    clearTimeout(pressTimer);
    pressTimer = setTimeout(() => fn(), 380);
  };
  const cancel = () => clearTimeout(pressTimer);
  el.addEventListener("touchstart", start, {passive:true});
  el.addEventListener("touchend", cancel);
  el.addEventListener("touchcancel", cancel);
  el.addEventListener("mousedown", start);
  el.addEventListener("mouseup", cancel);
  el.addEventListener("mouseleave", cancel);
}
function showTip(title, text){
  $tipTitle.textContent = title;
  $tipText.textContent = text;
  $tip.style.display = "block";
}
function hideTip(){ $tip.style.display = "none"; }
document.addEventListener("click", (e)=>{
  if($tip.style.display === "block"){
    const inside = e.target.closest("#tip");
    const isCell = e.target.closest(".cellBtn");
    if(!inside && !isCell) hideTip();
  }
}, true);

/* =========================
   Active getters
   ========================= */
function getActiveCourse(){ return db.courses[db.activeCourseId]; }
function getActiveRubric(){
  const course = getActiveCourse();
  return course.rubrics[db.activeRubricId];
}

/* =========================
   Render selects
   ========================= */
function renderCourseSelect(){
  $courseSelect.innerHTML = "";
  Object.entries(db.courses).forEach(([id, c])=>{
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = c.name;
    if(id === db.activeCourseId) opt.selected = true;
    $courseSelect.appendChild(opt);
  });
}
function renderRubricSelect(){
  $rubricSelect.innerHTML = "";
  const course = getActiveCourse();
  Object.entries(course.rubrics).forEach(([id, r])=>{
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = r.name;
    if(id === db.activeRubricId) opt.selected = true;
    $rubricSelect.appendChild(opt);
  });
}

/* =========================
   Copy selectors
   ========================= */
function renderCopySelectors(){
  $copyFromCourse.innerHTML = "";
  const other = Object.entries(db.courses).filter(([cid]) => cid !== db.activeCourseId);

  if(other.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay otros cursos";
    $copyFromCourse.appendChild(opt);

    $copyFromRubric.innerHTML = "";
    const optR = document.createElement("option");
    optR.value = "";
    optR.textContent = "‚Äî";
    $copyFromRubric.appendChild(optR);
    return;
  }

  other.forEach(([cid, c], idx)=>{
    const opt = document.createElement("option");
    opt.value = cid;
    opt.textContent = c.name;
    if(idx===0) opt.selected = true;
    $copyFromCourse.appendChild(opt);
  });
  renderCopyRubrics();
}
function renderCopyRubrics(){
  $copyFromRubric.innerHTML = "";
  const cid = $copyFromCourse.value;
  if(!cid || !db.courses[cid]){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "‚Äî";
    $copyFromRubric.appendChild(opt);
    return;
  }
  const rubrics = db.courses[cid].rubrics;
  const entries = Object.entries(rubrics);
  if(entries.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay r√∫bricas";
    $copyFromRubric.appendChild(opt);
    return;
  }
  entries.forEach(([rid, r], idx)=>{
    const opt = document.createElement("option");
    opt.value = rid;
    opt.textContent = r.name;
    if(idx===0) opt.selected = true;
    $copyFromRubric.appendChild(opt);
  });
}
$copyFromCourse.onchange = renderCopyRubrics;

/* =========================
   Load rubric into form
   ========================= */
function loadRubricIntoForm(){
  const r = getActiveRubric();
  $alumnos.value = r.alumnos || "";
  $indicadores.value = r.indicadores || "";
  $pesos.value = r.pesos || "";
  $descripciones.value = r.descripciones || "";

  if(r.tableState && r.tableState.rows){
    buildTableFromState();
  }else{
    $tabla.innerHTML = "";
    updateStats(null);
  }
}
function saveFormToRubric(){
  const r = getActiveRubric();
  r.alumnos = $alumnos.value;
  r.indicadores = $indicadores.value;
  r.pesos = $pesos.value;
  r.descripciones = $descripciones.value;
  saveDB(db);
}

/* =========================
   Actions: course/rubric CRUD
   ========================= */
document.getElementById("addCourse").onclick = () => {
  const name = ($courseName.value || "").trim();
  if(!name){ alert("Escribe el nombre del curso."); return; }
  const id = uid();
  const rubricId = uid();
  db.courses[id] = {
    name,
    rubrics: {
      [rubricId]: { name:"R√∫brica 1", alumnos:"", indicadores:"", pesos:"", descripciones:"", tableState:null }
    }
  };
  db.activeCourseId = id;
  db.activeRubricId = rubricId;
  $courseName.value = "";
  saveDB(db);
  refreshAll();
};

document.getElementById("delCourse").onclick = () => {
  const keys = Object.keys(db.courses);
  if(keys.length <= 1){ alert("Debe quedar al menos 1 curso."); return; }
  const courseName = getActiveCourse().name;
  if(!confirm(`¬øEliminar el curso "${courseName}" y todas sus r√∫bricas?`)) return;

  delete db.courses[db.activeCourseId];
  const nextId = Object.keys(db.courses)[0];
  db.activeCourseId = nextId;
  db.activeRubricId = Object.keys(db.courses[nextId].rubrics)[0];
  saveDB(db);
  refreshAll();
};

document.getElementById("addRubric").onclick = () => {
  const name = ($rubricName.value || "").trim();
  if(!name){ alert("Escribe el nombre de la r√∫brica."); return; }
  const course = getActiveCourse();
  const id = uid();
  course.rubrics[id] = { name, alumnos:"", indicadores:"", pesos:"", descripciones:"", tableState:null };
  db.activeRubricId = id;
  $rubricName.value = "";
  saveDB(db);
  refreshAll();
};

document.getElementById("dupRubric").onclick = () => {
  const course = getActiveCourse();
  const r = getActiveRubric();
  const id = uid();
  course.rubrics[id] = JSON.parse(JSON.stringify({...r, name: r.name + " (copia)"}));
  db.activeRubricId = id;
  saveDB(db);
  refreshAll();
};

document.getElementById("delRubric").onclick = () => {
  const course = getActiveCourse();
  const keys = Object.keys(course.rubrics);
  if(keys.length <= 1){ alert("Debe quedar al menos 1 r√∫brica en el curso."); return; }
  const name = getActiveRubric().name;
  if(!confirm(`¬øEliminar la r√∫brica "${name}"?`)) return;
  delete course.rubrics[db.activeRubricId];
  db.activeRubricId = Object.keys(course.rubrics)[0];
  saveDB(db);
  refreshAll();
};

$courseSelect.onchange = () => {
  db.activeCourseId = $courseSelect.value;
  db.activeRubricId = Object.keys(getActiveCourse().rubrics)[0];
  saveDB(db);
  refreshAll();
};
$rubricSelect.onchange = () => {
  db.activeRubricId = $rubricSelect.value;
  saveDB(db);
  refreshAll();
};

/* Renombrar */
document.getElementById("renameCourse").onclick = () => {
  const c = getActiveCourse();
  const nuevo = prompt("Nuevo nombre del curso:", c.name);
  if(nuevo === null) return;
  const name = nuevo.trim();
  if(!name){ alert("Nombre vac√≠o. No se cambia."); return; }
  c.name = name;
  saveDB(db);
  refreshAll();
};
document.getElementById("renameRubric").onclick = () => {
  const r = getActiveRubric();
  const nuevo = prompt("Nuevo nombre de la r√∫brica:", r.name);
  if(nuevo === null) return;
  const name = nuevo.trim();
  if(!name){ alert("Nombre vac√≠o. No se cambia."); return; }
  r.name = name;
  saveDB(db);
  refreshAll();
};

/* Copiar r√∫brica entre cursos */
function copyRubric({withMarks}){
  const fromCourseId = $copyFromCourse.value;
  const fromRubricId = $copyFromRubric.value;

  if(!fromCourseId || !db.courses[fromCourseId]){ alert("Selecciona un curso de origen."); return; }
  if(!fromRubricId || !db.courses[fromCourseId].rubrics[fromRubricId]){ alert("Selecciona una r√∫brica de origen."); return; }

  const origen = db.courses[fromCourseId].rubrics[fromRubricId];
  const copia = JSON.parse(JSON.stringify(origen));
  copia.name = `${origen.name} (copiada)`;

  if(!withMarks){
    copia.alumnos = "";
    copia.tableState = null;
  }

  const newId = uid();
  db.courses[db.activeCourseId].rubrics[newId] = copia;
  db.activeRubricId = newId;
  saveDB(db);
  refreshAll();
}
document.getElementById("copyNoMarks").onclick = () => copyRubric({withMarks:false});
document.getElementById("copyWithMarks").onclick = () => copyRubric({withMarks:true});

/* =========================
   Table state helpers
   ========================= */
function normalizeRow(row, nInds){
  if(!row || typeof row !== "object") row = {};
  if(!Array.isArray(row.cells)) row.cells = [];
  row.cells = row.cells.slice(0, nInds);
  while(row.cells.length < nInds) row.cells.push(0);
  if(typeof row.comment !== "string") row.comment = "";
  return row;
}

/* Crear desde cero */
function ensureStateFromCurrentInputs(){
  const alumnos = parseAlumnos($alumnos.value);
  const inds = parseIndicadores($indicadores.value);
  if(!alumnos.length || !inds.length) return null;

  const r = getActiveRubric();
  const w = parseWeights($pesos.value, inds.length);
  $pesos.value = w.map(x=>x.toFixed(1)).join(",");

  r.tableState = {
    alumnos,
    indicadores: inds,
    rows: alumnos.map(()=>({cells: inds.map(()=>0), comment: ""}))
  };

  r.alumnos = $alumnos.value;
  r.indicadores = $indicadores.value;
  r.pesos = $pesos.value;
  r.descripciones = $descripciones.value;

  saveDB(db);
  return r.tableState;
}

/* ‚úÖ Aplicar cambios SIN perder notas:
   - alumnos: conserva por nombre exacto
   - indicadores: conserva por nombre exacto
   - pesos: recalcula/normaliza
*/
function applyChangesKeepData(){
  const r = getActiveRubric();

  // Si a√∫n no existe tabla, crea desde cero
  if(!r.tableState || !r.tableState.rows){
    const st = ensureStateFromCurrentInputs();
    if(!st){ alert("Rellena alumnado e indicadores antes."); return; }
    buildTableFromState();
    return;
  }

  const st = r.tableState;

  // MIGRACI√ìN (por si vienes de versiones anteriores)
  st.alumnos = Array.isArray(st.alumnos) ? st.alumnos : [];
  st.indicadores = Array.isArray(st.indicadores) ? st.indicadores : [];
  st.rows = Array.isArray(st.rows) ? st.rows : [];
  // asegurar que cada fila tenga comment y cells
  st.rows = st.rows.map(row => normalizeRow(row, st.indicadores.length));

  const newAlumnos = parseAlumnos($alumnos.value);
  const newInds = parseIndicadores($indicadores.value);

  if(!newAlumnos.length){ alert("Lista de alumnado vac√≠a."); return; }
  if(!newInds.length){ alert("Lista de indicadores vac√≠a."); return; }

  // Pesos (siempre)
  const w = parseWeights($pesos.value, newInds.length);
  $pesos.value = w.map(x=>x.toFixed(1)).join(",");

  // --- Mapas por nombre ---
  const oldInds = st.indicadores;
  const oldIndPos = new Map(oldInds.map((name, idx)=>[name, idx])); // nombre -> idx viejo

  // para cada nuevo indicador, de qu√© columna vieja viene (-1 si nuevo)
  const indMap = newInds.map(name => oldIndPos.has(name) ? oldIndPos.get(name) : -1);

  const oldAlumnos = st.alumnos;
  const oldRows = st.rows;

  const oldRowByAlumno = new Map();
  oldAlumnos.forEach((name, idx)=>{
    if(!oldRowByAlumno.has(name)) oldRowByAlumno.set(name, oldRows[idx]);
  });

  // Construir nuevas filas conservando celdas por indicador
  const newRows = newAlumnos.map(alName=>{
    let row = oldRowByAlumno.get(alName);
    if(!row) row = {cells: [], comment: ""};

    // reconstruir celdas seg√∫n nuevo orden/altas/bajas de indicadores
    const oldCells = Array.isArray(row.cells) ? row.cells : [];
    const rebuilt = indMap.map(oldIdx => (oldIdx >= 0 ? (oldCells[oldIdx] ?? 0) : 0));

    row.cells = rebuilt;
    row = normalizeRow(row, newInds.length);
    return row;
  });

  // aplicar al estado
  st.alumnos = newAlumnos;
  st.indicadores = newInds;
  st.rows = newRows;

  // guardar formulario
  r.alumnos = $alumnos.value;
  r.indicadores = $indicadores.value;
  r.pesos = $pesos.value;
  r.descripciones = $descripciones.value;

  saveDB(db);
  buildTableFromState();
}

/* =========================
   Render table + calc
   ========================= */
function buildTableFromState(){
  const r = getActiveRubric();
  const st = r.tableState;
  if(!st){ $tabla.innerHTML=""; updateStats(null); return; }

  // MIGRACI√ìN segura
  st.alumnos = Array.isArray(st.alumnos) ? st.alumnos : [];
  st.indicadores = Array.isArray(st.indicadores) ? st.indicadores : [];
  st.rows = Array.isArray(st.rows) ? st.rows : [];
  st.rows = st.rows.map(row => normalizeRow(row, st.indicadores.length));
  saveDB(db);

  const inds = st.indicadores;
  const alumnos = st.alumnos;
  const weights = parseWeights(r.pesos || "", inds.length);
  const descMap = parseIndicatorDescriptions(r.descripciones || "");

  let html = `<div class="tableWrap"><table><thead><tr><th>Alumno/a</th>`;
  inds.forEach((name, idx)=>{
    html += `<th>${escapeHTML(name)}<span class="w">${weights[idx].toFixed(1)}%</span></th>`;
  });
  html += `<th class="avg">Media</th><th class="nota">Nota /10</th><th class="comment">Comentario</th></tr></thead><tbody>`;

  alumnos.forEach((al, i)=>{
    html += `<tr><td>${escapeHTML(al)}</td>`;
    inds.forEach((ind, j)=>{
      const n = (st.rows?.[i]?.cells?.[j] ?? 0);
      const color = (LEVELS.find(x=>x.n===n) || LEVELS[0]).color;
      html += `<td>
        <div class="cellBtn" data-i="${i}" data-j="${j}" data-n="${n}" data-ind="${escapeHTML(ind)}" style="background:${color}">
          ${n===0 ? "" : String(n)}
        </div>
      </td>`;
    });

    const existingComment = (st.rows?.[i]?.comment ?? "");
    html += `
      <td class="avg"><span class="rowAvg">‚Äî</span></td>
      <td class="nota"><span class="rowNota">‚Äî</span></td>
      <td class="comment">
        <textarea class="commentBox" data-i="${i}" placeholder="Escribe comentario...">${escapeHTML(existingComment)}</textarea>
      </td>
    </tr>`;
  });

  html += `</tbody></table></div>`;
  $tabla.innerHTML = html;

  // Click en celdas: 0-4
  document.querySelectorAll(".cellBtn").forEach(cell=>{
    const i = parseInt(cell.dataset.i,10);
    const j = parseInt(cell.dataset.j,10);

    cell.addEventListener("click", ()=>{
      const cur = parseInt(cell.dataset.n || "0",10);
      const next = (cur + 1) % 5;
      cell.dataset.n = String(next);
      cell.textContent = next===0 ? "" : String(next);
      cell.style.background = (LEVELS.find(x=>x.n===next) || LEVELS[0]).color;

      const rr = getActiveRubric();
      rr.tableState.rows[i].cells[j] = next;
      saveDB(db);
      recalcAll();
    });

    attachLongPress(cell, ()=>{
      const n = parseInt(cell.dataset.n || "0",10);
      const indName = (cell.dataset.ind || "");
      const desc = getDesc(indName, n, descMap);
      const title = n===0 ? `${indName}` : `${indName} ‚Äî Nivel ${n}`;
      showTip(title, desc);
    });
  });

  // Comentarios: guardar al escribir
  document.querySelectorAll(".commentBox").forEach(box=>{
    box.addEventListener("input", ()=>{
      const i = parseInt(box.dataset.i, 10);
      const rr = getActiveRubric();
      if(rr.tableState && rr.tableState.rows && rr.tableState.rows[i]){
        rr.tableState.rows[i].comment = box.value;
        saveDB(db);
      }
    });
  });

  recalcAll();
}

function recalcAll(){
  const r = getActiveRubric();
  const st = r.tableState;
  if(!st){ updateStats(null); return; }

  const inds = st.indicadores || [];
  const weightsPct = parseWeights(r.pesos || "", inds.length);
  const weights = weightsPct.map(x=>x/100);

  const rows = Array.from(document.querySelectorAll("tbody tr"));
  let evaluated = 0;
  const totalCells = rows.length * inds.length;

  let classSum04 = 0, classSum10 = 0, classCount = 0;

  rows.forEach((tr)=>{
    const cells = Array.from(tr.querySelectorAll(".cellBtn"));
    let any = false, sum04 = 0, sum10 = 0;

    cells.forEach((c, j)=>{
      const n = parseInt(c.dataset.n || "0",10);
      if(n>0){ any=true; evaluated++; }
      sum04 += n * (weights[j] || 0);
      sum10 += levelTo10(n) * (weights[j] || 0);
    });

    const avgEl = tr.querySelector(".rowAvg");
    const notaEl = tr.querySelector(".rowNota");

    if(!any){
      avgEl.textContent = "‚Äî";
      notaEl.textContent = "‚Äî";
    }else{
      avgEl.textContent = sum04.toFixed(2);
      notaEl.textContent = sum10.toFixed(2);
      classSum04 += sum04;
      classSum10 += sum10;
      classCount++;
    }
  });

  updateStats({
    mediaClase: classCount ? classSum04/classCount : null,
    notaClase:  classCount ? classSum10/classCount : null,
    pct: totalCells ? (evaluated/totalCells)*100 : 0
  });
}

function updateStats(s){
  if(!s){
    $mediaClase.textContent="‚Äî";
    $notaClase.textContent="‚Äî";
    $pctEval.textContent="‚Äî";
    return;
  }
  $mediaClase.textContent = (s.mediaClase==null) ? "‚Äî" : s.mediaClase.toFixed(2);
  $notaClase.textContent  = (s.notaClase==null)  ? "‚Äî" : s.notaClase.toFixed(2);
  $pctEval.textContent    = `${Math.round(s.pct)}%`;
}

/* =========================
   Buttons
   ========================= */
document.getElementById("btnCrear").onclick = () => {
  saveFormToRubric();
  const st = ensureStateFromCurrentInputs();
  if(!st){ alert("Rellena alumnado e indicadores antes de crear."); return; }
  buildTableFromState();
};

document.getElementById("btnAplicar").onclick = () => {
  saveFormToRubric();
  applyChangesKeepData();
};

document.getElementById("btnGuardar").onclick = () => {
  // Solo guarda textos (y si hay tabla, refresca cabecera y recalcula)
  saveFormToRubric();
  const r = getActiveRubric();
  if(r.tableState) buildTableFromState();
  else alert("Guardado. Pulsa Crear para generar la tabla.");
};

document.getElementById("btnExport").onclick = () => exportCSV();

/* =========================
   Export CSV (incluye comentario)
   ========================= */
function sanitizeFile(s){
  return String(s||"").replaceAll(/[\\/:*?"<>|]/g," ").trim().replaceAll(/\s+/g,"_").slice(0,60) || "rubrica";
}
function exportCSV(){
  const r = getActiveRubric();
  const st = r.tableState;
  if(!st){ alert("No hay r√∫brica creada para exportar."); return; }

  // compat
  st.rows = (st.rows||[]).map(row => normalizeRow(row, (st.indicadores||[]).length));

  const inds = st.indicadores || [];
  const weights = parseWeights(r.pesos || "", inds.length);
  const descMap = parseIndicatorDescriptions(r.descripciones || "");

  const header = ["Alumno/a", ...inds.map((x,i)=> `${x} (${weights[i].toFixed(1)}%)`), "Media(0-4)", "Nota(/10)", "Comentario"];
  const lines = [header];

  st.alumnos.forEach((al, i)=>{
    const cells = st.rows[i].cells;
    const w = weights.map(x=>x/100);
    let sum04 = 0, sum10 = 0, any = false;

    const vals = cells.map((n, j)=>{
      if(n>0) any=true;
      sum04 += n * (w[j]||0);
      sum10 += levelTo10(n) * (w[j]||0);
      if(n===0) return "";
      const desc = getDesc(inds[j], n, descMap);
      return `${n} - ${desc}`;
    });

    const comment = st.rows?.[i]?.comment ?? "";
    lines.push([al, ...vals, any ? sum04.toFixed(2) : "", any ? sum10.toFixed(2) : "", comment]);
  });

  const csv = lines
    .map(r => r.map(s => `"${String(s).replaceAll('"','""')}"`).join(";"))
    .join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${sanitizeFile(getActiveCourse().name)}_${sanitizeFile(getActiveRubric().name)}.csv`;
  a.click();
}

/* =========================
   Live autosave suave (solo textos)
   ========================= */
let tLive = null;
function debounceLive(){
  clearTimeout(tLive);
  tLive = setTimeout(()=> saveFormToRubric(), 250);
}
$alumnos.addEventListener("input", debounceLive);
$indicadores.addEventListener("input", debounceLive);
$pesos.addEventListener("input", debounceLive);
$descripciones.addEventListener("input", debounceLive);

/* =========================
   Refresh all
   ========================= */
function refreshAll(){
  renderCourseSelect();
  renderRubricSelect();
  renderCopySelectors();
  loadRubricIntoForm();
}
saveDB(db);
refreshAll();
</script>

</body>
</html>
