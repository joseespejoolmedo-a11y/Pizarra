<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Pizarra PRO ‚Äî Caligraf√≠a (Pencil + Dedo)</title>
<style>
:root{--bg:#0f1317;--panel:#151a20;--line:#2a3340;--text:#e9eef4;--muted:#a7b2be;--accent:#6aa9ff;--board-bg:#0b0f13;--grid-color:rgba(255,255,255,.08)}
[data-theme="light"]{--bg:#f8f9fa;--panel:#fff;--line:#dee2e6;--text:#212529;--muted:#6c757d;--accent:#0d6efd;--board-bg:#fff;--grid-color:rgba(0,0,0,.08)}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0;display:flex;flex-direction:column;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overscroll-behavior:none;
  -webkit-user-select:none;user-select:none
}
#toolbar{
  z-index:10;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;
  background:var(--panel);border-bottom:1px solid var(--line);padding:.5rem;flex-shrink:0
}
.group{display:flex;gap:.35rem;align-items:center;background:var(--bg);border:1px solid var(--line);border-radius:.6rem;padding:.35rem .45rem}
.btn{background:var(--panel);border:1px solid var(--line);color:var(--text);padding:.45rem .6rem;border-radius:.55rem;cursor:pointer;font-weight:600}
.btn.active{outline:2px solid var(--accent)}
.btn.toggle.on{outline:2px solid var(--accent)}
label{font-size:.9rem;color:var(--muted);display:flex;align-items:center;gap:.35rem}
input[type=range]{width:120px}
#colors .sw{width:26px;height:26px;border-radius:50%;border:2px solid #0008;cursor:pointer;box-shadow:0 0 0 2px #0005 inset}
#board{display:block;background:var(--board-bg);touch-action:none;flex-grow:1;width:100%}
#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:#1f2a33;color:#fff;border:1px solid #2f3b46;border-radius:.6rem;padding:.35rem .6rem;font-size:.85rem;display:none;z-index:999}
</style>
</head>
<body>
  <div id="toolbar">
    <div class="group">
      <button class="btn" data-tool="pen">‚úèÔ∏è L√°piz</button>
      <button class="btn" data-tool="eraser">üßΩ Goma</button>
      <label>Grosor <input id="penSize" type="range" min="1" max="40" value="6"></label>
      <label>Goma <input id="eraserSize" type="range" min="6" max="80" value="22"></label>
      <label>Texto <input id="textSize" type="range" min="12" max="80" value="28"></label>
    </div>

    <div class="group" id="colors"></div>

    <div class="group">
      <span>Figuras:</span>
      <button class="btn" data-tool="line">Ôºè</button>
      <button class="btn" data-tool="arrow">‚û§</button>
      <button class="btn" data-tool="rect">‚ñ≠</button>
      <button class="btn" data-tool="ellipse">‚óØ</button>
      <button class="btn" data-tool="triangle">‚ñ≥</button>
      <button class="btn" data-tool="text">T</button>
    </div>

    <div class="group">
      <button class="btn" id="undo">‚Ü∂</button>
      <button class="btn" id="redo">‚Ü∑</button>
      <button class="btn" id="clear">üóëÔ∏è Limpiar</button>
    </div>

    <div class="group">
      <button class="btn" id="save">üñºÔ∏è PNG</button>
      <button class="btn" id="resetView">üîç 100%</button>
      <button class="btn" id="themeToggle">‚òÄÔ∏è Tema</button>
      <button class="btn" id="fsToggle">‚õ∂ Pantalla completa</button>
    </div>

    <div class="group">
      <button class="btn toggle on" id="calliToggle">ùíû Caligraf√≠a: ON</button>
      <select id="calliStyle" title="Estilo">
        <option value="academica" selected>Acad√©mica</option>
        <option value="romantica">Rom√°ntica</option>
      </select>
    </div>
  </div>

  <canvas id="board" draggable="false"></canvas>
  <div id="toast"></div>

<script>
(()=>{
// ===== util =====
const $=s=>document.querySelector(s);
const toastEl=$("#toast");
const toast=t=>{toastEl.textContent=t;toastEl.style.display='block';clearTimeout(toastEl._t);toastEl._t=setTimeout(()=>toastEl.style.display='none',1200)};

// ===== canvas / c√°mara =====
const cv=document.getElementById('board');
const ctx=cv.getContext('2d',{alpha:true,desynchronized:true});
let dpr=Math.max(1,window.devicePixelRatio||1);
let cam={x:0,y:0,s:1}; const minS=.25,maxS=8; let drawNow=true;
cv.style.touchAction='none';
function fit(){const w=cv.clientWidth,h=cv.clientHeight; dpr=Math.max(1,window.devicePixelRatio||1);
  cv.width=Math.round(w*dpr); cv.height=Math.round(h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0); drawNow=true;
}
new ResizeObserver(fit).observe(cv); fit();
const toWorld=(px,py)=>{const r=cv.getBoundingClientRect();return {x:(px-r.width/2)/cam.s-cam.x,y:(py-r.height/2)/cam.s-cam.y}};
const worldToScreen=(wx,wy)=>{const r=cv.getBoundingClientRect();return {sx:(wx+cam.x)*cam.s+r.width/2,sy:(wy+cam.y)*cam.s+r.height/2}};
const applyCam=()=>{const r=cv.getBoundingClientRect();ctx.setTransform(dpr,0,0,dpr,0,0);ctx.translate(r.width/2,r.height/2);ctx.scale(cam.s,cam.s);ctx.translate(cam.x,cam.y)};

// ===== UI / herramientas =====
const toolBtns=[...document.querySelectorAll('[data-tool]')];
function highlight(t){toolBtns.forEach(b=>b.classList.toggle('active',b.dataset.tool===t))}
function setTool(t){tool.mode=t;highlight(t)}
const tool={mode:'pen',color:'#ffffff',penSize:6,eraserSize:22,textSize:28, calliOn:true, calliStyle:'academica'};
$("#penSize").oninput=e=>tool.penSize=+e.target.value;
$("#eraserSize").oninput=e=>tool.eraserSize=+e.target.value;
$("#textSize").oninput=e=>tool.textSize=+e.target.value;
toolBtns.forEach(b=>b.onclick=()=>setTool(b.dataset.tool)); setTool('pen');

const calliToggle=$("#calliToggle"), calliStyleSel=$("#calliStyle");
function updateCalliUI(){ calliToggle.textContent=tool.calliOn?'ùíû Caligraf√≠a: ON':'ùíû Caligraf√≠a: OFF'; calliToggle.classList.toggle('on', tool.calliOn); }
calliToggle.onclick=()=>{ tool.calliOn=!tool.calliOn; updateCalliUI(); toast('Caligraf√≠a '+(tool.calliOn?'activada':'desactivada')); };
calliStyleSel.onchange=e=> tool.calliStyle=e.target.value;
updateCalliUI();

const colors=['#ffffff','#ff3b30','#34c759','#0a84ff','#ffd60a','#ff9f0a','#a55eea','#50c8ff','#ff6b6b','#a7b2be'];
const colorsWrap=$("#colors");
colors.forEach(c=>{const d=document.createElement('div');d.className='sw';d.style.background=c;d.onclick=()=>{tool.color=c;setTool('pen')};colorsWrap.appendChild(d)});

$("#themeToggle").onclick=()=>{const el=document.documentElement; el.dataset.theme = el.dataset.theme==='light'?'dark':'light'; drawNow=true;};
$("#resetView").onclick=()=>{cam={x:0,y:0,s:1};drawNow=true;toast('Vista 100%')};

const fsBtn=$("#fsToggle");
const isFS=()=>document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement;
const updateFSUI=()=>{fsBtn.textContent=isFS()?'ü°º Salir pantalla completa':'‚õ∂ Pantalla completa'};
async function enterFS(){const el=document.documentElement; try{if(el.requestFullscreen)await el.requestFullscreen({navigationUI:'hide'}); else if(el.webkitRequestFullscreen)el.webkitRequestFullscreen(); else if(el.msRequestFullscreen)el.msRequestFullscreen();}catch(_){}} 
async function exitFS(){try{if(document.exitFullscreen)await document.exitFullscreen(); else if(document.webkitExitFullscreen)document.webkitExitFullscreen(); else if(document.msExitFullscreen)document.msExitFullscreen();}catch(_){}} 
fsBtn.onclick=async()=>{if(isFS())await exitFS(); else await enterFS();};
document.addEventListener('fullscreenchange',()=>{updateFSUI();fit()});
document.addEventListener('webkitfullscreenchange',()=>{updateFSUI();fit()});

// ===== datos / undo =====
let objects=[]; const objs=()=>objects;
let undoStack=[], redoStack=[];
const snap=()=>JSON.stringify({cam,objects});
const commit=()=>{redoStack.length=0;undoStack.push(snap());if(undoStack.length>80)undoStack.shift()};
const restore=txt=>{const s=JSON.parse(txt); cam=s.cam; objects=s.objects; drawNow=true;};
$("#undo").onclick=()=>{if(!undoStack.length)return; redoStack.push(snap()); restore(undoStack.pop()); toast('‚Ü∂');};
$("#redo").onclick=()=>{if(!redoStack.length)return; undoStack.push(snap()); restore(redoStack.pop()); toast('‚Ü∑');};

// ===== caligraf√≠a =====
function calliParams(style){
  return (style==='romantica')
    ? { nibAngle: Math.PI/4,     contrast: 0.95, taperPts:10, smoothStep:2.2, fingerScale:0.60 }
    : { nibAngle: Math.PI*0.9/3, contrast: 0.75, taperPts: 8, smoothStep:2.5, fingerScale:0.70 };
}
function getNibAngleFromEvent(e){
  if(e.pointerType!=='pen') return null;
  if(typeof e.azimuthAngle==='number') return e.azimuthAngle;
  if(typeof e.tiltX==='number' && typeof e.tiltY==='number') return Math.atan2(e.tiltY, e.tiltX);
  return null;
}

// ===== dibujo de objetos =====
const makeStroke=(erase=false)=>({type:'stroke',color:tool.color,size:erase?tool.eraserSize:tool.penSize,erase,pts:[],_lastRenderedIdx:0,
                                  calli:false,nibAngle:0,contrast:.7,taperPts:8,pointerType:''});
const addPt=(st,p)=>{const last=st.pts[st.pts.length-1];const t=performance.now();const v=last?Math.hypot(p.x-last.x,p.y-last.y)/Math.max(1,t-last.t):0; const a= last ? Math.atan2(p.y-last.y,p.x-last.x):0; st.pts.push({x:p.x,y:p.y,t,pr:p.pr||.5,v,a});};
function strokeW(st,pt,i,len){
  if(st.erase) return st.size;
  const base=(pt.pr>0)?(0.35+pt.pr*0.9):(1.10/(1+4*(pt.v||0)));
  let w=st.size*base;
  if(st.calli){ const ang=(pt.a!=null)?pt.a:0; const mod=0.55 + st.contrast*Math.abs(Math.sin(ang - st.nibAngle)); w*=mod; }
  const T=st.taperPts||8;
  if(len>T*2){ if(i<T){const t=i/(T-1); w*=t*t*(3-2*t);} else if(i>len-T){const t=(len-1-i)/(T-1); w*=t*t*(3-2*t);} }
  return Math.max(.8,Math.min(st.size*1.6,w));
}
function drawStroke(st){
  const pts=st.pts; if(!pts.length) return;
  ctx.save(); ctx.globalCompositeOperation=st.erase?'destination-out':'source-over';
  ctx.strokeStyle=st.erase?'#000':st.color; ctx.fillStyle=ctx.strokeStyle; ctx.lineCap='round'; ctx.lineJoin='round';
  if(pts.length===1){const p=pts[0]; const w=strokeW(st,p,0,1); ctx.beginPath(); ctx.arc(p.x,p.y,w/2,0,Math.PI*2); ctx.fill();}
  else{for(let i=0;i<pts.length-1;i++){const p1=pts[i],p2=pts[i+1]; const w=(strokeW(st,p1,i,pts.length)+strokeW(st,p2,i+1,pts.length))/2; ctx.lineWidth=w; ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke();}}
  ctx.restore();
}
function drawShape(s,dashed=false){
  ctx.save(); ctx.globalCompositeOperation='source-over'; ctx.lineCap='round'; ctx.lineJoin='round';
  ctx.strokeStyle=s.color; ctx.lineWidth=s.size; if(dashed) ctx.setLineDash([8,6]);
  const x1=Math.min(s.x1,s.x2),y1=Math.min(s.y1,s.y2),x2=Math.max(s.x1,s.x2),y2=Math.max(s.y1,s.y2),w=x2-x1,h=y2-y1; ctx.beginPath();
  if(s.shape==='line'){ctx.moveTo(s.x1,s.y1);ctx.lineTo(s.x2,s.y2);}
  else if(s.shape==='arrow'){ctx.moveTo(s.x1,s.y1);ctx.lineTo(s.x2,s.y2); const ang=Math.atan2(s.y2-s.y1,s.x2-s.x1),len=Math.max(10,8+s.size*1.5);
    ctx.moveTo(s.x2,s.y2); ctx.lineTo(s.x2-len*Math.cos(ang-Math.PI/7), s.y2-len*Math.sin(ang-Math.PI/7));
    ctx.moveTo(s.x2,s.y2); ctx.lineTo(s.x2-len*Math.cos(ang+Math.PI/7), s.y2-len*Math.sin(ang+Math.PI/7)); }
  else if(s.shape==='rect'){ctx.rect(x1,y1,w,h);}
  else if(s.shape==='ellipse'){ctx.ellipse(x1+w/2,y1+h/2,w/2,h/2,0,0,Math.PI*2);}
  else if(s.shape==='triangle'){ctx.moveTo(x1+w/2,y1);ctx.lineTo(x1,y2);ctx.lineTo(x2,y2);ctx.closePath();}
  ctx.stroke(); ctx.restore();
}
function drawText(t){ctx.save();ctx.globalCompositeOperation='source-over';ctx.fillStyle=t.color;ctx.font=`${t.size}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;ctx.textBaseline='top';ctx.fillText(t.text,t.x,t.y);ctx.restore();}

// ===== gu√≠as (grid) y m√°rgenes fijos =====
function drawGrid(){
  const r=cv.getBoundingClientRect(), start=toWorld(0,0), end=toWorld(r.width,r.height);
  const step=50, x0=Math.floor(start.x/step)*step, y0=Math.floor(start.y/step)*step;
  ctx.save(); ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid-color'); ctx.lineWidth=1/cam.s;
  for(let x=x0;x<end.x;x+=step){ctx.beginPath();ctx.moveTo(x,start.y);ctx.lineTo(x,end.y);ctx.stroke();}
  for(let y=y0;y<end.y;y+=step){ctx.beginPath();ctx.moveTo(start.x,y);ctx.lineTo(end.x,y);ctx.stroke();}
  ctx.restore();
}
function drawScreenMargins(){
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.save(); const accent=(getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#6aa9ff').trim();
  ctx.strokeStyle=accent; ctx.lineWidth=2; const W=cv.width/dpr,H=cv.height/dpr;
  ctx.beginPath(); ctx.moveTo(0, .5); ctx.lineTo(W, .5); ctx.stroke(); // arriba
  ctx.beginPath(); ctx.moveTo(.5, 0); ctx.lineTo(.5, H); ctx.stroke(); // izquierda
  ctx.restore();
}

// ===== render =====
function drawScene(){
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,cv.width/dpr,cv.height/dpr);
  applyCam();
  drawGrid();
  for(const o of objs()){
    if(o.type==='stroke') drawStroke(o);
    else if(o.type==='shape') drawShape(o,false);
    else if(o.type==='text')  drawText(o);
  }
  drawScreenMargins(); // sobreimpreso
}
function render(){ if(!drawNow){requestAnimationFrame(render);return} drawNow=false; drawScene(); if(drawing) drawStroke(drawing); requestAnimationFrame(render); }
render();

// ===== entrada =====
const pointers=new Map();
let drawing=null, preview=null;
let lastStroke=null;

const getPt=e=>{const r=cv.getBoundingClientRect();const sx=e.clientX-r.left,sy=e.clientY-r.top;const w=toWorld(sx,sy);return {sx,sy,wx:w.x,wy:w.y,pr:e.pressure||.5,ptType:e.pointerType||''};};
function drawNewSegments(st){
  const pts=st.pts; const startIdx=st._lastRenderedIdx>0?st._lastRenderedIdx-1:0; if(pts.length<=startIdx) return;
  ctx.setTransform(dpr,0,0,dpr,0,0); applyCam(); ctx.save();
  ctx.globalCompositeOperation=st.erase?'destination-out':'source-over'; ctx.strokeStyle=st.erase?'#000':st.color; ctx.lineCap='round'; ctx.lineJoin='round';
  for(let i=startIdx;i<pts.length-1;i++){const p1=pts[i],p2=pts[i+1];const w=(strokeW(st,p1,i,pts.length)+strokeW(st,p2,i+1,pts.length))/2;ctx.lineWidth=w;ctx.beginPath();ctx.moveTo(p1.x,p1.y);ctx.lineTo(p2.x,p2.y);ctx.stroke();}
  ctx.restore(); st._lastRenderedIdx=pts.length;
}
// suavizado final (caligraf√≠a)
function movingAverage(pts,win=2){if(pts.length<=2)return pts.slice();const out=[];for(let i=0;i<pts.length;i++){let sx=0,sy=0,n=0;for(let k=-win;k<=win;k++){const j=Math.min(pts.length-1,Math.max(0,i+k));sx+=pts[j].x;sy+=pts[j].y;n++;}out.push({...pts[i],x:sx/n,y:sy/n});}return out;}
function resample(pts,step){if(pts.length<2)return pts.slice();const out=[pts[0]];for(let i=1;i<pts.length;i++){let a=out[out.length-1],b=pts[i];let dx=b.x-a.x,dy=b.y-a.y,dist=Math.hypot(dx,dy);while(dist>=step){const t=step/dist;const nx=a.x+dx*t,ny=a.y+dy*t;out.push({x:nx,y:ny,pr:b.pr,t:b.t});dx=b.x-nx;dy=b.y-ny;dist=Math.hypot(dx,dy);} }out.push(pts[pts.length-1]);return out;}
function finalizeStroke(st){
  if(!st.calli || st.erase) return;
  const ps=calliParams(st.style||'academica');
  let pts=st.pts;
  pts=resample(pts, ps.smoothStep);
  pts=movingAverage(pts, 2);
  for(let i=1;i<pts.length;i++){const a=Math.atan2(pts[i].y-pts[i-1].y, pts[i].x-pts[i-1].x); pts[i].a=a; pts[i-1].a=pts[i-1].a ?? a;}
  st.pts=pts; st._lastRenderedIdx=0; drawNow=true;
}

function startStroke(e, P, erase=false){
  const st=makeStroke(erase);
  st.pointerType=e.pointerType||'';
  const wantsCalli=tool.calliOn && !erase && tool.mode==='pen';
  if(wantsCalli){
    const ps=calliParams(tool.calliStyle);
    st.calli=true; st.style=tool.calliStyle;
    const isFinger=st.pointerType==='touch';
    st.size=Math.max(2, Math.round(tool.penSize*(isFinger?ps.fingerScale:1)));
    const ang0=getNibAngleFromEvent(e);
    st.nibAngle=(ang0!=null)?ang0:ps.nibAngle;
    st.contrast=ps.contrast; st.taperPts=ps.taperPts;
  }
  // uni√≥n con trazo anterior
  if(lastStroke?.pts?.length){
    const last=lastStroke.pts[lastStroke.pts.length-1];
    const dt=performance.now()-(last.t||0);
    const dist=Math.hypot(P.wx-last.x,P.wy-last.y);
    const need=(erase?tool.eraserSize:st.size)*0.9;
    if(dt<160 && dist<need){ st.pts.push({x:last.x,y:last.y,t:performance.now(),pr:P.pr,v:last.v,a:last.a}); st._lastRenderedIdx=1; }
  }
  addPt(st,{x:P.wx,y:P.wy,pr:P.pr});
  objs().push(st);
  drawing=st; drawNow=true;
}

cv.addEventListener('pointerdown',e=>{
  e.preventDefault(); cv.setPointerCapture(e.pointerId);
  const P=getPt(e); pointers.set(e.pointerId,P);
  if(tool.mode==='pen' || tool.mode==='eraser'){ startStroke(e,P, tool.mode==='eraser'); return; }
  const shapeTools=['line','arrow','rect','ellipse','triangle'];
  if(shapeTools.includes(tool.mode)){ preview={type:'shape',shape:tool.mode,color:tool.color,size:tool.penSize,x1:P.wx,y1:P.wy,x2:P.wx,y2:P.wy}; drawNow=true; return; }
  if(tool.mode==='text'){ const txt=prompt('Texto:'); if(!txt) return; objs().push({type:'text',text:txt,x:P.wx,y:P.wy,color:tool.color,size:tool.textSize}); drawNow=true; commit(); toast('Texto a√±adido'); }
},{passive:false});

cv.addEventListener('pointermove',e=>{
  if(drawing){
    // alimentaci√≥n de puntos (coalesced) + orientaci√≥n del Pencil
    const evs=(e.getCoalescedEvents&&e.getCoalescedEvents())||[e];
    for(const ce of evs){
      const p=getPt(ce); addPt(drawing,{x:p.wx,y:p.wy,pr:p.pr});
      if(drawing.calli && drawing.pointerType==='pen'){ const ang=getNibAngleFromEvent(ce); if(ang!=null) drawing.nibAngle=ang; }
    }
    drawNewSegments(drawing);
    return;
  }
  if(preview){ const p=getPt(e); preview.x2=p.wx; preview.y2=p.wy; drawNow=true; }
},{passive:false});

cv.addEventListener('pointerup',e=>{
  if(drawing){ finalizeStroke(drawing); lastStroke=drawing; drawing=null; commit(); drawNow=true; }
  if(preview?.type==='shape'){ objs().push(preview); preview=null; commit(); drawNow=true; }
},{passive:false});

cv.addEventListener('pointercancel',()=>{ if(drawing){ finalizeStroke(drawing); drawing=null; } },{passive:false});
cv.addEventListener('contextmenu',e=>e.preventDefault());

// ===== zoom/pan con rueda (iPad: gesto con dos dedos lo hace el SO) =====
cv.addEventListener('wheel',e=>{
  e.preventDefault();
  const r=cv.getBoundingClientRect();
  const before=toWorld(e.clientX-r.left,e.clientY-r.top);
  cam.s=Math.max(minS,Math.min(maxS,cam.s*(1+(-Math.sign(e.deltaY)*0.1))));
  const after=toWorld(e.clientX-r.left,e.clientY-r.top);
  cam.x+=(after.x-before.x); cam.y+=(after.y-before.y);
  drawNow=true;
},{passive:false});

// ===== limpiar / PNG =====
$("#clear").onclick=()=>{if(confirm('¬øBorrar todo?')){objects.length=0;preview=null;commit();drawNow=true}};
$("#save").onclick=()=>{try{const url=cv.toDataURL('image/png');const a=document.createElement('a');a.href=url;a.download=`pizarra-${Date.now()}.png`;document.body.appendChild(a);a.click();a.remove();}catch(e){alert('Si hay im√°genes por URL sin CORS, el navegador puede bloquear el PNG.')}};

// ===== colores =====
document.querySelectorAll('#colors .sw').forEach(d=>d.style.cursor='pointer');

// inicio
commit(); drawNow=true; updateFSUI(); toast('Pizarra lista ¬∑ Caligraf√≠a con Dedo + Pencil ‚ú®');
})();
</script>
</body>
</html>
