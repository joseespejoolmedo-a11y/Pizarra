
  try{
    const raw = localStorage.getItem(DB_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function saveDB(db){
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function defaultDB(){
  // Crea un curso y una rúbrica inicial para que no esté vacío
  const courseId = uid();
  const rubricId = uid();
  return {
    activeCourseId: courseId,
    activeRubricId: rubricId,
    courses: {
      [courseId]: {
        name: "Curso 1",
        rubrics: {
          [rubricId]: {
            name: "Rúbrica 1",
            alumnos: "",
            indicadores: "",
            pesos: "",
            descripciones: "",
            tableState: null, // {rows:[{cells:[n...] }]}
          }
        }
      }
    }
  };
}
let db = loadDB() || defaultDB();

/* =========================
   DOM
   ========================= */
const $courseSelect = document.getElementById("courseSelect");
const $rubricSelect = document.getElementById("rubricSelect");
const $courseName = document.getElementById("courseName");
const $rubricName = document.getElementById("rubricName");

const $alumnos = document.getElementById("alumnos");
const $indicadores = document.getElementById("indicadores");
const $pesos = document.getElementById("pesos");
const $descripciones = document.getElementById("descripciones");
const $tabla = document.getElementById("tabla");

const $mediaClase = document.getElementById("mediaClase");
const $notaClase = document.getElementById("notaClase");
const $pctEval = document.getElementById("pctEval");

const $tip = document.getElementById("tip");
const $tipTitle = document.getElementById("tipTitle");
const $tipText = document.getElementById("tipText");
document.getElementById("tipClose").onclick = () => hideTip();

/* =========================
   Helpers parse
   ========================= */
function escapeHTML(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function parseAlumnos(txt){
  return txt.split("\n").map(s=>s.trim()).filter(Boolean);
}

function parseIndicadores(txt){
  const t = txt.trim();
  if(!t) return [];
  // si hay comas, usar comas; si no, líneas
  if(t.includes(",")){
    return t.split(",").map(s=>s.trim()).filter(Boolean);
  }
  return t.split("\n").map(s=>s.trim()).filter(Boolean);
}

function parseWeights(txt, n){
  const t = (txt||"").trim();
  if(!t){
    const eq = 100/n;
    return Array(n).fill(eq);
  }
  let w = t.split(",").map(x => Number(String(x).trim().replace(",", "."))).filter(x => isFinite(x) && x>=0);
  if(w.length !== n){
    const eq = 100/n;
    return Array(n).fill(eq);
  }
  const sum = w.reduce((a,b)=>a+b,0) || 1;
  return w.map(x => (x/sum)*100);
}

function parseIndicatorDescriptions(txt){
  const map = new Map();
  const lines = (txt||"").split("\n").map(l=>l.trim()).filter(Boolean);
  for(const line of lines){
    const parts = line.split("|");
    if(parts.length < 2) continue;
    const name = parts[0].trim();
    const rhs = parts.slice(1).join("|").trim();
    const levelMap = {1:"",2:"",3:"",4:""};
    const chunks = rhs.split(";").map(x=>x.trim()).filter(Boolean);
    for(const c of chunks){
      const m = c.match(/^([1-4])\s*:\s*(.+)$/);
      if(m) levelMap[Number(m[1])] = m[2].trim();
    }
    map.set(name, levelMap);
  }
  return map;
}

function defaultDesc(n){
  if(n===1) return "Inicio";
  if(n===2) return "Básico";
  if(n===3) return "Adecuado";
  if(n===4) return "Avanzado";
  return "Sin evaluar";
}
function getDesc(indName, n, descMap){
  if(n===0) return "Sin evaluar";
  const m = descMap.get(indName);
  if(m && m[n]) return m[n];
  return defaultDesc(n);
}

/* =========================
   Tooltip
   ========================= */
let pressTimer = null;
function attachLongPress(el, fn){
  const start = (e) => {
    clearTimeout(pressTimer);
    pressTimer = setTimeout(() => fn(e), 380);
  };
  const cancel = () => clearTimeout(pressTimer);
  el.addEventListener("touchstart", start, {passive:true});
  el.addEventListener("touchend", cancel);
  el.addEventListener("touchcancel", cancel);
  el.addEventListener("mousedown", start);
  el.addEventListener("mouseup", cancel);
  el.addEventListener("mouseleave", cancel);
}
function showTip(title, text){
  $tipTitle.textContent = title;
  $tipText.textContent = text;
  $tip.style.display = "block";
}
function hideTip(){ $tip.style.display = "none"; }

/* =========================
   Active getters/setters
   ========================= */
function getActiveCourse(){
  return db.courses[db.activeCourseId];
}
function getActiveRubric(){
  const course = getActiveCourse();
  return course.rubrics[db.activeRubricId];
}

/* =========================
   UI render selects
   ========================= */
function renderCourseSelect(){
  $courseSelect.innerHTML = "";
  const entries = Object.entries(db.courses);
  entries.forEach(([id, c])=>{
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = c.name;
    if(id === db.activeCourseId) opt.selected = true;
    $courseSelect.appendChild(opt);
  });
}
function renderRubricSelect(){
  $rubricSelect.innerHTML = "";
  const course = getActiveCourse();
  const entries = Object.entries(course.rubrics);
  entries.forEach(([id, r])=>{
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = r.name;
    if(id === db.activeRubricId) opt.selected = true;
    $rubricSelect.appendChild(opt);
  });
}

/* =========================
   Load rubric into editor
   ========================= */
function loadRubricIntoForm(){
  const r = getActiveRubric();
  $alumnos.value = r.alumnos || "";
  $indicadores.value = r.indicadores || "";
  $pesos.value = r.pesos || "";
  $descripciones.value = r.descripciones || "";
  // Render table if state exists, else clear
  if(r.tableState && r.tableState.rows){
    buildTableFromState();
  }else{
    $tabla.innerHTML = "";
    updateStats(null);
  }
}

/* =========================
   Save form into rubric
   ========================= */
function saveFormToRubric(){
  const r = getActiveRubric();
  r.alumnos = $alumnos.value;
  r.indicadores = $indicadores.value;
  r.pesos = $pesos.value;
  r.descripciones = $descripciones.value;
  // tableState se actualiza al tocar celdas o al crear
  saveDB(db);
}

/* =========================
   Course / Rubric actions
   ========================= */
document.getElementById("addCourse").onclick = () => {
  const name = ($courseName.value || "").trim();
  if(!name){ alert("Escribe el nombre del curso."); return; }
  const id = uid();
  const rubricId = uid();
  db.courses[id] = {
    name,
    rubrics: {
      [rubricId]: { name:"Rúbrica 1", alumnos:"", indicadores:"", pesos:"", descripciones:"", tableState:null }
    }
  };
  db.activeCourseId = id;
  db.activeRubricId = rubricId;
  $courseName.value = "";
  saveDB(db);
  refreshAll();
};

document.getElementById("delCourse").onclick = () => {
  const keys = Object.keys(db.courses);
  if(keys.length <= 1){ alert("Debe quedar al menos 1 curso."); return; }
  const courseName = getActiveCourse().name;
  if(!confirm(`¿Eliminar el curso "${courseName}" y todas sus rúbricas?`)) return;
  delete db.courses[db.activeCourseId];
  // elegir otro curso
  const nextId = Object.keys(db.courses)[0];
  db.activeCourseId = nextId;
  db.activeRubricId = Object.keys(db.courses[nextId].rubrics)[0];
  saveDB(db);
  refreshAll();
};

document.getElementById("addRubric").onclick = () => {
  const name = ($rubricName.value || "").trim();
  if(!name){ alert("Escribe el nombre de la rúbrica."); return; }
  const course = getActiveCourse();
  const id = uid();
  course.rubrics[id] = { name, alumnos:"", indicadores:"", pesos:"", descripciones:"", tableState:null };
  db.activeRubricId = id;
  $rubricName.value = "";
  saveDB(db);
  refreshAll();
};

document.getElementById("dupRubric").onclick = () => {
  const course = getActiveCourse();
  const r = getActiveRubric();
  const id = uid();
  const name = r.name + " (copia)";
  course.rubrics[id] = JSON.parse(JSON.stringify({...r, name}));
  db.activeRubricId = id;
  saveDB(db);
  refreshAll();
};

document.getElementById("delRubric").onclick = () => {
  const course = getActiveCourse();
  const keys = Object.keys(course.rubrics);
  if(keys.length <= 1){ alert("Debe quedar al menos 1 rúbrica en el curso."); return; }
  const name = getActiveRubric().name;
  if(!confirm(`¿Eliminar la rúbrica "${name}"?`)) return;
  delete course.rubrics[db.activeRubricId];
  db.activeRubricId = Object.keys(course.rubrics)[0];
  saveDB(db);
  refreshAll();
};

$courseSelect.onchange = () => {
  db.activeCourseId = $courseSelect.value;
  const course = getActiveCourse();
  db.activeRubricId = Object.keys(course.rubrics)[0];
  saveDB(db);
  refreshAll();
};

$rubricSelect.onchange = () => {
  db.activeRubricId = $rubricSelect.value;
  saveDB(db);
  refreshAll();
};

/* =========================
   Table building
   ========================= */
function ensureStateFromCurrentInputs(){
  const alumnos = parseAlumnos($alumnos.value);
  const inds = parseIndicadores($indicadores.value);
  if(!alumnos.length || !inds.length) return null;
  const r = getActiveRubric();

  // Crear estado con todo a 0
  r.tableState = {
    alumnos,
    indicadores: inds,
    rows: alumnos.map(()=>({cells: inds.map(()=>0)}))
  };
  // Normaliza pesos y lo escribe
  const w = parseWeights($pesos.value, inds.length);
  $pesos.value = w.map(x=>x.toFixed(1)).join(",");
  r.pesos = $pesos.value;

  saveFormToRubric();
  saveDB(db);
  return r.tableState;
}

function buildTableFromState(){
  const r = getActiveRubric();
  const st = r.tableState;
  if(!st) { $tabla.innerHTML=""; return; }

  const inds = st.indicadores || [];
  const alumnos = st.alumnos || [];
  const weights = parseWeights(r.pesos || "", inds.length);
  const descMap = parseIndicatorDescriptions(r.descripciones || "");

  let html = `<div class="tableWrap"><table><thead><tr>
    <th>Alumno/a</th>`;

  inds.forEach((name, idx)=>{
    html += `<th>${escapeHTML(name)}<span class="w">${weights[idx].toFixed(1)}%</span></th>`;
  });

  html += `<th class="avg">Media</th><th class="nota">Nota /10</th></tr></thead><tbody>`;

  alumnos.forEach((al, i)=>{
    html += `<tr><td>${escapeHTML(al)}</td>`;
    inds.forEach((ind, j)=>{
      const n = (st.rows?.[i]?.cells?.[j] ?? 0);
      const color = (LEVELS.find(x=>x.n===n) || LEVELS[0]).color;
      html += `<td>
        <div class="cellBtn" data-i="${i}" data-j="${j}" data-n="${n}" data-ind="${escapeHTML(ind)}" style="background:${color}">
          ${n===0 ? "" : String(n)}
        </div>
      </td>`;
    });
    html += `<td class="avg"><span class="rowAvg">—</span></td>
             <td class="nota"><span class="rowNota">—</span></td></tr>`;
  });

  html += `</tbody></table></div>`;
  $tabla.innerHTML = html;

  // activar eventos
  document.querySelectorAll(".cellBtn").forEach(cell=>{
    const i = parseInt(cell.dataset.i,10);
    const j = parseInt(cell.dataset.j,10);

    cell.addEventListener("click", ()=>{
      const cur = parseInt(cell.dataset.n || "0",10);
      const next = (cur + 1) % 5;
      cell.dataset.n = String(next);

      // Solo número visible
      cell.textContent = next===0 ? "" : String(next);

      // Color
      const color = (LEVELS.find(x=>x.n===next) || LEVELS[0]).color;
      cell.style.background = color;

      // guardar en estado
      const r = getActiveRubric();
      r.tableState.rows[i].cells[j] = next;
      saveFormToRubric();
      saveDB(db);

      // recalcular
      recalcAll();
    });

    attachLongPress(cell, ()=>{
      const n = parseInt(cell.dataset.n || "0",10);
      const indName = (cell.dataset.ind || "");
      const desc = getDesc(indName, n, descMap);
      const title = n===0 ? `${indName}` : `${indName} — Nivel ${n}`;
      showTip(title, desc);
    });
  });

  recalcAll();
}

function recalcAll(){
  const r = getActiveRubric();
  const st = r.tableState;
  if(!st){ updateStats(null); return; }

  const inds = st.indicadores || [];
  const weightsPct = parseWeights(r.pesos || "", inds.length);
  const weights = weightsPct.map(x=>x/100);

  const rows = Array.from(document.querySelectorAll("tbody tr"));
  let evaluated = 0;
  const totalCells = rows.length * inds.length;

  let classSum04 = 0;
  let classSum10 = 0;
  let classCount = 0;

  rows.forEach((tr, i)=>{
    const cells = Array.from(tr.querySelectorAll(".cellBtn"));
    let any = false;

    // Media ponderada 0-4
    let sum04 = 0;
    let sum10 = 0;
    cells.forEach((c, j)=>{
      const n = parseInt(c.dataset.n || "0",10);
      if(n>0){ any=true; evaluated++; }
      sum04 += n * (weights[j] || 0);
      sum10 += levelTo10(n) * (weights[j] || 0);
    });

    const avgEl = tr.querySelector(".rowAvg");
    const notaEl = tr.querySelector(".rowNota");

    if(!any){
      avgEl.textContent = "—";
      notaEl.textContent = "—";
    }else{
      avgEl.textContent = sum04.toFixed(2);
      notaEl.textContent = sum10.toFixed(2);
      classSum04 += sum04;
      classSum10 += sum10;
      classCount++;
    }
  });

  const mediaClase = classCount ? (classSum04/classCount) : null;
  const notaClase = classCount ? (classSum10/classCount) : null;

  updateStats({
    mediaClase,
    notaClase,
    pct: totalCells ? (evaluated/totalCells)*100 : 0
  });
}

function updateStats(s){
  if(!s){
    $mediaClase.textContent="—";
    $notaClase.textContent="—";
    $pctEval.textContent="—";
    return;
  }
  $mediaClase.textContent = (s.mediaClase==null) ? "—" : s.mediaClase.toFixed(2);
  $notaClase.textContent  = (s.notaClase==null)  ? "—" : s.notaClase.toFixed(2);
  $pctEval.textContent    = `${Math.round(s.pct)}%`;
}

/* =========================
   Buttons
   ========================= */
document.getElementById("btnCrear").onclick = () => {
  // guardar inputs primero
  saveFormToRubric();
  // crear estado nuevo (resetea celdas)
  const st = ensureStateFromCurrentInputs();
  if(!st){
    alert("Rellena alumnado e indicadores antes de crear.");
    return;
  }
  buildTableFromState();
};

document.getElementById("btnGuardar").onclick = () => {
  // guarda inputs + recalcula con nuevos pesos (sin rehacer)
  saveFormToRubric();
  const r = getActiveRubric();

  // si hay tabla creada, solo recalcular y actualizar cabeceras
  if(r.tableState){
    // actualizar indicadores/alumnos si el usuario los cambió sin rehacer:
    // (mantendremos la tabla como está; lo recomendable si cambian listas es “Rehacer”)
    buildTableFromState();
  }else{
    // nada creado aún
    saveDB(db);
    alert("Guardado. (Crea la tabla para evaluar)");
  }
};

document.getElementById("btnExport").onclick = () => {
  exportCSV();
};

/* =========================
   Export CSV
   ========================= */
function exportCSV(){
  const r = getActiveRubric();
  const st = r.tableState;
  if(!st){
    alert("No hay rúbrica creada para exportar.");
    return;
  }
  const inds = st.indicadores || [];
  const weights = parseWeights(r.pesos || "", inds.length);
  const descMap = parseIndicatorDescriptions(r.descripciones || "");

  const header = ["Alumno/a", ...inds.map((x,i)=> `${x} (${weights[i].toFixed(1)}%)`), "Media(0-4)", "Nota(/10)"];
  const lines = [header];

  st.alumnos.forEach((al, i)=>{
    const cells = st.rows[i].cells;
    // media/nota como en pantalla (ponderadas)
    const w = weights.map(x=>x/100);
    let sum04 = 0, sum10 = 0;
    let any = false;

    const vals = cells.map((n, j)=>{
      if(n>0) any=true;
      sum04 += n * (w[j]||0);
      sum10 += levelTo10(n) * (w[j]||0);
      if(n===0) return "";
      const desc = getDesc(inds[j], n, descMap);
      return `${n} - ${desc}`;
    });

    const avg = any ? sum04.toFixed(2) : "";
    const nota = any ? sum10.toFixed(2) : "";
    lines.push([al, ...vals, avg, nota]);
  });

  const csv = lines
    .map(r => r.map(s => `"${String(s).replaceAll('"','""')}"`).join(";"))
    .join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${sanitizeFile(db.courses[db.activeCourseId].name)}_${sanitizeFile(getActiveRubric().name)}.csv`;
  a.click();
}

function sanitizeFile(s){
  return String(s||"").replaceAll(/[\\/:*?"<>|]/g," ").trim().replaceAll(/\s+/g,"_").slice(0,60) || "rubrica";
}

/* =========================
   Auto-save live (sin pelearte)
   ========================= */
function liveSave(){
  saveFormToRubric();
  // si hay tabla, recalcular cabeceras/medias al vuelo
  const r = getActiveRubric();
  if(r.tableState){
    // NO destruimos notas; solo reconstruimos la vista con el estado actual
    buildTableFromState();
  }
}
let tLive = null;
function debounceLive(){
  clearTimeout(tLive);
  tLive = setTimeout(liveSave, 250);
}
$alumnos.addEventListener("input", debounceLive);
$indicadores.addEventListener("input", debounceLive);
$pesos.addEventListener("input", debounceLive);
$descripciones.addEventListener("input", debounceLive);

// Cerrar tooltip tocando fuera
document.addEventListener("click", (e)=>{
  if($tip.style.display === "block"){
    const inside = e.target.closest("#tip");
    const isCell = e.target.closest(".cellBtn");
    if(!inside && !isCell) hideTip();
  }
}, true);

/* =========================
   Refresh
   ========================= */
function refreshAll(){
  renderCourseSelect();
  renderRubricSelect();
  loadRubricIntoForm();
}
saveDB(db);
refreshAll();
</script>

</body>
</html>
